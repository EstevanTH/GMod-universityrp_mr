# Computer & projector: slideshows & videos

This add-on contains a computer, a projector and a projector screen. You may configure your own slideshow JSON library.

[This add-on on Steam Workshop](https://steamcommunity.com/sharedfiles/filedetails/?id=2128234105)

## Features

- Slideshows composed of pictures (usually screenshots), HTML pages, Google Docs slideshows, YouTube videos
- Slideshows hosted on web servers or on *Steam Workshop*
- Slideshow library hosted as a local file or on a web server
- Optimized readability
- Many hooks

## Requirements

The server and the clients must have *Counter-Strike: Source* or *Counter-Strike: Global Offensive* mounted.

To make the equipments persistent, the add-on *[Persistent equipments saver & entities remover](../../tree/universityrp_mr_spawn)* is necessary.

To improve the readability, the add-on *[Seat: zoom & volatile 3rd person](../../tree/universityrp_seats_zoom_thirdperson)* is recommended.

For optimization and meeting / classroom usage, the add-on *[Rooms location management library](https://github.com/EstevanTH/GMod-rooms_lib_mr)* is highly recommended.

Maps compiled with HDR are not recommended. The add-on tries its best to mitigate the brightness problems introduced by the High Dynamic Range: it disables the bloom and it sets the tone mapping scale to `1.` when a screen is rendered. You may want to use [HDR disabler for servers](https://steamcommunity.com/sharedfiles/filedetails/?id=595984057) to disable the HDR on a map that you did not compile.

## Usage

The computer is controlled by sitting on the chair that is linked to it. A VGUI control pad appears on the screen to control the computer and the linked equipments.

On the control pad, buttons on the left column are for actions of the starting process and those on the right column are for the finishing process. You can control the computer, the program (based on Windows XP and OpenOffice 4 Impress), the projector and the projector screen.

When you start the slideshow, you are given a remote control. The primary attack loads the next slide, the secondary attack loads the previous slide. When you leave the computer's seat, you lose the possibility to do actions on the computer, but the remote control lets you control the slideshow progress, the projector and the projector screen.

## Setting up

The setting up process is actually simple. Putting together your own slideshow library is probably the most difficult part. Slideshows can also be hosted on *Steam Workshop* for everyone to use, in which case it does not take place in your slideshow library.

### Linking equipments together

The computer must be linked with a seat, otherwise it cannot be used. If you want to use a projector screen, you need to link a projector with the computer and with a projector screen.

For this, there is a Toolgun tool named **Equipments linker (MR)** under the **University RP** category.

A ready-to-use desk including a computer and a chair is also available.

**Note:** third-party entity saving tools (such as the popular *[Permaprops](https://steamcommunity.com/sharedfiles/filedetails/?id=220336312)*) can restore the equipments, but they cannot restore equipment associations. Please use the specific tool *[Persistent equipments saver & entities remover](../../tree/universityrp_mr_spawn)* instead.

### Making your slideshow library

The slideshow library is a text file using the JSON language. The content must follow a specific format, which is described below. A tiny example can be found at [`lessons_library.json.vvd`](models/prop_teacher_computer_mr/lessons_library.json.vvd) and a complete example is available at [`lessons_library.json`](../_config/data/prop_teacher_computer_mr/lessons_library.json).

As a neat idea, I suggest you to have the lessons JSON library generated by a web server. It is great with a slideshow submission & voting system!

#### Root

The root element of the slideshow library is a JSON object.

```json
{
}
```

#### Categories

In the root element, each category name is a key and the value is a JSON array.

A category name cannot begin with the underscore character `_` because such names are reserved for special uses.

Do not forget that the last element of a JSON object or array must not be followed by a comma.

```json
{
	"Examples": [
	],
	"More examples": [
	],
	"Extra examples": [
	]
}
```

#### Slideshows

A slideshow is defined as a JSON object contained in the array of a category.

```json
{
	"Examples": [
		{
			"title": "3 example slides",
			"filename": "3 example slides.odp",
			"keywords": ["3", "example", "slides"],
			"count": 3,
			"slides": [
				"asset://garrysmod/materials/prop_teacher_computer_mr/lessons/example/slide_%u.png"
			]
		}
	]
}
```

A slideshow may contain these parameters:

- `"title"`: *(string)* title as displayed in the Open dialog
- `"hl"`: *(string)* the 2-letter language identifier (ISO 639-1) of the slideshow  
    **Note:** If unspecified, the slideshow language is considered to always match the server's language.
- `"filename"`: *(string)* filename as displayed in the title bar in OpenOffice Impress
- `"keywords"`: *(array of strings)* keywords (lowercase, no accents) that can be typed in a search feature (currently unused)
- `"count"`: *(integer)* when specified, `"slides"` will have its first URL formatted `count` times with numbers from `1` to `count`  
    This is intended to avoid URL repetitions where only slide numbers differ.  
    The formatting uses `string.format()`. The "reference URL" can contain parameters expressed [according to this table](https://en.cppreference.com/w/c/io/fprintf#Parameters).  
    **Note:** Formatted URLs cannot contain escaped URL characters (which use the `%` character).  
    **Note:** This field is automatically stripped after formatting the URLs.
- `slides`: *(array of strings)* slide URLs, the 1st item can be a formatted URL  
    **Note:** A *string* URL is always internally converted into a JSON *object* with the fields `"url"` and `"starttime"`.  
    **Note:** YouTube video URLs should be specified in the form `https://www.youtube-nocookie.com/embed/VIDEO-ID`. The URL parameters `start` and `end` are allowed. The `start` parameter is implicitly stripped and converted into the `"starttime"` field, used for late viewers to start playing videos at the current time. Implicit parameters are added for the best experience.
- `"preview"`: *(string)* URL of the preview picture that is visible when the slideshow is open but not running  
    **Note:** The field can be omitted if the first slide is a picture URL: the first slide is used as a fallback.  
    **Note:** The field can be omitted for YouTube videos: a YouTube thumbnail URL is used as a fallback.
- `"whitelist"`: *(array of strings)* if specified, only players who match any of the contained SteamIDs (`"STEAM_0:....."`), groups, and team global variable names (`"TEAM_....."`) can load the slideshow.  
    **Note:** This field is automatically stripped and transformed into the new field `allowed`.

#### Multi-language slideshow library

The purpose of this feature is to make a single slideshow library available on servers with different languages.

Translation items take place in the special slideshow category `"_language"`.

Currently, only slideshow categories can be translated. They are contained in a `"categories"` JSON object.

I hope that this example is self-explanatory enough. The reference language is French (implicitly) and the categories are translated into English:

```json
{
	"_language": {
		"categories": {
			"Automobile": {
				"en": "Automobile"
			},
			"Éducation": {
				"en": "Education"
			},
			"Électronique": {
				"en": "Electronics"
			},
			"Exemples": {
				"en": "Examples"
			},
			"Humour": {
				"en": "Humor"
			},
			"Logiciels": {
				"en": "Software"
			}
		}
	}
}
```

### Configuration files

- [`data/prop_teacher_computer_mr/lessons_library.json`](../_config/data/prop_teacher_computer_mr/lessons_library.json) (default path)
- [`lua/config/prop_ceiling_projector_mr/shared.lua`](../_config/lua/config/prop_ceiling_projector_mr/shared.lua)
- [`lua/config/prop_projector_screen_mr/shared.lua`](../_config/lua/config/prop_projector_screen_mr/shared.lua)
- [`lua/config/prop_teacher_computer_mr/server.lua`](../_config/lua/config/prop_teacher_computer_mr/server.lua)
- [`lua/config/prop_teacher_computer_mr/shared.lua`](../_config/lua/config/prop_teacher_computer_mr/shared.lua)

## Making a slideshow for the Workshop

To make a slideshow for the Workshop, please follow this example.

Create a Lua file in `lua/slideshows/prop_teacher_computer_mr/` and name it something unique, lowercase, English characters only, following the naming rule `the-category_the-title_the-author-name.lua` (for easier management). Put this content inside:

```lua
resource.AddWorkshop("9876543210")

prop_teacher_computer_mr.registerLesson("Examples", {
	title = "3 example slides",
	filename = "3 example slides.odp",
	keywords = {"3", "example", "slides"},
	count = 3,
	slides = {
		"asset://garrysmod/materials/slideshows/the-category_the-title_the-author-name/slide_%u.png",
	},
})
```

The slideshow *Lua table* is simply the equivalent of the slideshow *JSON object*.

Content files:

- Embedded content uses the `asset://` protocol. Only PNG and JPEG pictures are known to be allowed here. It requires you to use `resource.AddWorkshop()` for the content to be visible for clients. The pictures are stored in the `materials/slideshows/the-category_the-title_the-author-name/` folder of your add-on.
- External content uses either the `http://` protocol or the `https://` protocol. As mentioned earlier, you can use pictures, HTML pages and YouTube videos.

In this example:

- The category name is *Examples*.
- The title is *3 example slides*.
- The displayed filename is `3 example slides.odp`.
- The keywords are *3*, *example*, *slides*.
- The slides pictures are embedded in the add-on. Their paths are:
    - `materials/slideshows/the-category_the-title_the-author-name/slide_1.png`
    - `materials/slideshows/the-category_the-title_the-author-name/slide_2.png`
    - `materials/slideshows/the-category_the-title_the-author-name/slide_3.png`

## Triggered events

These are examples usages of `hook.Add()` for events triggered in this add-on.

The slideshows (aka. lessons) are always normalized (meaning that they have been fixed at least once by `prop_teacher_computer_mr.fixLessonInfo()`).

- *:blue_heart: SERVER:* `prop_teacher_computer_mr:canUseComputer`  
    Checks whether a player can use a computer.

```lua
hook.Add("prop_teacher_computer_mr:canUseComputer", "PUT IDENTIFIER HERE", function(ply, computer)
	-- Return a boolean to override the default decision.
end)
```

- *:blue_heart: SERVER:* `canOpenSlideshow_mr`  
    Checks whether a player can open a slideshow.

```lua
hook.Add("canOpenSlideshow_mr", "PUT IDENTIFIER HERE", function(lesson, ply, computer)
	-- Return a boolean to override the default decision.
end)
```

- *:blue_heart: SERVER:* `prop_teacher_computer_mr:registerLuaLesson`  
    For every slideshow defined outside the slideshow JSON library, checks if it will be registered into the list.  
    Modifications in the `lesson` table are allowed. Be aware that the passed slideshow is already normalized.

```lua
hook.Add("prop_teacher_computer_mr:registerLuaLesson", "PUT IDENTIFIER HERE", function(lesson)
	-- Return a boolean to override the default decision.
end)
```

## Hooks added on specific events from other add-ons

- *:orange_heart: CLIENT:* `findFirstPersonOverlayComputer_mr`

```lua
hook.Add("findFirstPersonOverlayComputer_mr", "prop_teacher_computer_mr:cl", .....)
```

- *:orange_heart: CLIENT:* `newFirstPersonOverlayComputer_mr`

```lua
hook.Add("newFirstPersonOverlayComputer_mr", "prop_teacher_computer_mr:cl", .....)
```

- *:orange_heart: CLIENT:* `canUseFirstPersonZoom_mr`

```lua
hook.Add("canUseFirstPersonZoom_mr", "prop_teacher_computer_mr:cl", .....)
```

- *:blue_heart: SERVER:* `seat_natural_leaving:shouldDo`

```lua
hook.Add("seat_natural_leaving:shouldDo", "prop_teacher_computer_mr:sv", .....)
```

- *:black_heart: SHARED:* `findStartableLesson_mr`

```lua
hook.Add("findStartableLesson_mr", "prop_teacher_computer_mr:sh", .....)
```

## Public entity methods

### Class `prop_ceiling_projector_mr`

- *:black_heart: SHARED:* `Entity ENT:GetComputer()`  
    Retrieves the associated computer
- *:black_heart: SHARED:* `boolean ENT:GetOn()`  
    Returns the current "power on" status
- *:black_heart: SHARED:* `Entity ENT:GetProjectorProp()`  
    Returns the projector prop (which is located in the crate)
- *:black_heart: SHARED:* `Entity ENT:GetProjectorScreen()`  
    Returns the associated projector screen
- *:blue_heart: SERVER:* `ENT:SetOn(boolean on)`  
    See `ENT:GetOn()`
- *:blue_heart: SERVER:* `ENT:SetProjectorScreen(Entity projectorScreen)`  
    See `ENT:GetProjectorScreen()`

### Class `prop_projector_screen_mr`

- *:blue_heart: SERVER:* `no value ENT:closeScreen()`  
    Runs the screen closing process
- *:black_heart: SHARED:* `Entity ENT:GetComputer()`  
    Retrieves the associated computer
- *:black_heart: SHARED:* `float ENT:GetLastClosed()`  
    Returns the `CurTime()` from when the closing sequence started  
    A value of `0.` is returned if the last action is an opening sequence.
- *:black_heart: SHARED:* `float ENT:GetLastOpened()`  
    Returns the `CurTime()` from when the opening sequence started  
    A value of `0.` is returned if the last action is a closing sequence.
- *:black_heart: SHARED:* `Entity ENT:GetProjector()`  
    Retrieves the associated projector
- *:black_heart: SHARED:* `boolean ENT:isDeployed()`  
    Returns if an opening sequence is finished
- *:blue_heart: SERVER:* `no value ENT:openScreen()`  
    Runs the screen opening process

### Class `prop_teacher_computer_mr`

- *:black_heart: SHARED:* `no value ENT:actionSlideSetPage(int page)`  
    Changes the current slide number with state check  
    This can be used clientside for prediction.
- *:black_heart: SHARED:* `no value ENT:actionSlideNext()`  
    Changes the current slide number to the next one  
    This can be used clientside for prediction.
- *:black_heart: SHARED:* `no value ENT:actionSlidePrevious()`  
    Changes the current slide number to the previous one  
    This can be used clientside for prediction.
- *:black_heart: SHARED:* `string ENT:GetCurrentUrl()`  
    Returns the URL of the previous slide (except if it is a video)
- *:black_heart: SHARED:* `string ENT:GetFilename()`  
    Returns the displayed filename on OpenOffice Impress
- *:black_heart: SHARED:* `boolean ENT:GetForTechnician()`  
    Returns if the computer if for a technician use (clickable HTML renderer)
- *:black_heart: SHARED:* `string ENT:GetNextUrl()`  
    Returns the URL of the next slide (except if it is a video)
- *:black_heart: SHARED:* `int ENT:GetPage()`  
    Gets the current slide number
- *:black_heart: SHARED:* `string ENT:GetPreviewUrl()`  
    Returns the preview picture URL
- *:black_heart: SHARED:* `string ENT:GetPreviousUrl()`  
    Returns the URL of the current slide
- *:black_heart: SHARED:* `Entity ENT:GetProjector()`  
    Returns the associated projector
- *:black_heart: SHARED:* `Entity ENT:GetProjectorScreen()`  
    Retrieves the associated projector screen
- *:black_heart: SHARED:* `Player ENT:GetRemoteOwner()`  
    Returns the current owner of the remote control
- *:black_heart: SHARED:* `Vehicle ENT:GetSeat()`  
    Returns the associated seat
- *:black_heart: SHARED:* `int ENT:GetSlideshowPages()`  
    Returns the slides count of the loaded slideshow (or `0`)
- *:black_heart: SHARED:* `int ENT:GetState()`  
    Gets the computer state.  
- *:blue_heart: SERVER:* `Player ENT:GetUser()`  
    Retrieves the current computer user (the owner of the remote control or the player on the computer's seat)
- *:black_heart: SHARED:* `int ENT:GetVideoPosition_s()`  
    Returns the video position at which the playback should start  
    Check out `prop_teacher_computer_mr.actions` for valid values.
- *:blue_heart: SERVER:* `no value ENT:giveRemote(Player ply)`  
    Gives the specified player the remote control  
    There is no effect if someone already has the remote control.
- *:black_heart: SHARED:* `boolean ENT:isComputerOn()`  
    Returns if the computer is awake
- *:blue_heart: SERVER:* `no value ENT:loadLesson(table lesson)`  
    Loads the specified slideshow  
    The `lesson` table can be built from anywhere. Make sure that `prop_teacher_computer_mr.fixLessonInfo()` was called on it.
- *:blue_heart: SERVER:* `no value ENT:makePhoneProp()`  
    Creates the phone decoration prop
- *:blue_heart: SERVER:* `no value ENT:makeRemoteProp()`  
    Creates the prop of the remote control  
- *:blue_heart: SERVER:* `no value ENT:removeRemoteProp()`  
    Removes the prop of the remote control  
    This is automatically called by `ENT:SetProjector()`.
- *:blue_heart: SERVER:* `no value ENT:SetFilename(string filename)`  
    See `ENT:GetFilename()`
- *:black_heart: SHARED:* `no value ENT:SetForTechnician(boolean forTechnician)`  
    See `ENT:GetForTechnician()`
- *:black_heart: SHARED:* `no value ENT:SetPage(int page)`  
    See `ENT:GetPage()`  
- *:blue_heart: SERVER:* `no value ENT:SetProjector(Entity projector)`  
    Associates the specified projector
- *:black_heart: SHARED:* `no value ENT:SetRemoteOwner(Player remoteOwner)`  
    Sets the current owner of the remote control
- *:black_heart: SHARED:* `no value ENT:SetSeat(Vehicle seat)`  
    Sets the associated seat
- *:blue_heart: SERVER:* `no value ENT:SetState(int state)`  
    See `ENT:GetState()`  
    This can be used clientside for prediction.  
    This is automatically called by `ENT:SetProjector()`.
- *:blue_heart: SERVER:* `no value ENT:stripRemote()`  
    Strips the remote control from their current owner
- *:blue_heart: SERVER:* `no value ENT:turnComputerOn()`  
    Turns the computer on
- *:blue_heart: SERVER:* `no value ENT:turnComputerOff()`  
    Puts the computer into standby mode

## Public functions

- *:blue_heart: SERVER:* `table prop_teacher_computer_mr.fixLessonInfo(table lesson, table lang_server, table lang_others)`  
    Normalizes a slideshow table in-place and returns `lesson`  
    The optional slideshow lists `lang_server` & `lang_others` are used to distinguish slideshows by language upon refreshing the slideshow JSON library. They do not make sense when normalizing a manually created `lesson` table.
- *:orange_heart: CLIENT:* `prop_teacher_computer_mr.fixHdr()`  
    Fixes the High Dynamic Range for the current frame (disables bloom & sets tone mapping scale to `1.`)  
    This is called every time a screen is rendered.
- *:black_heart: SHARED:* `table prop_teacher_computer_mr.getAllComputers()`  
    Lists every computer in an optimized way  
    The computers are the keys and tbe values are always `true`.  
    This is more efficient than using `ents.FindByClass()` on many times.
- *:black_heart: SHARED:* `Entity prop_teacher_computer_mr.getComputerFromPlayer(Player ply, allComputers)`  
    Find the computer that a player is using.  
    `allComputers` is an optional cached version of the table provided by `prop_teacher_computer_mr.getAllComputers()`.
- *:black_heart: SHARED:* `Entity prop_teacher_computer_mr.getComputerFromSeat(Vehicle seat, allComputers)`  
    Find the computer associated with the specified seat.  
    `allComputers` is an optional cached version of the table provided by `prop_teacher_computer_mr.getAllComputers()`.
- *:black_heart: SHARED:* `string prop_teacher_computer_mr.getSameOriginFixingUrl(string url)`  
    Returns the root renderer URL substitution that fixes a `SAMEORIGIN` `X-Frame-Options` policy  
    When no substitution is applied, the root renderer URL is `about:blank`.  
    Please note that only 1 substitution is allowed in a slideshow.
- *:black_heart: SHARED:* `boolean prop_teacher_computer_mr.isPictureUrl(string url)`  
    Returns if the specified URL is recognized as a picture URL
- *:black_heart: SHARED:* `boolean prop_teacher_computer_mr.isVideoUrl(string url)`  
    Returns if the specified URL is recognized as a video URL
- *:black_heart: SHARED:* `boolean prop_teacher_computer_mr.isYouTubeUrl(string url)`  
    Returns if the specified URL is recognized as a YouTube video URL
- *:blue_heart: SERVER:* `no value prop_teacher_computer_mr.registerLesson(string category, table lesson)`  
    Registers a Lua-defined slideshow under the specified category  
    This is only meant for slideshows hosted on *Steam Workshop*.  
    This is only defined when loading Lua-defined slideshows, located in `lua/config/prop_teacher_computer_mr/lessons/`.  
    This function runs the `prop_teacher_computer_mr:registerLuaLesson` event.
- *:blue_heart: SERVER:* `boolean prop_teacher_computer_mr.slideshowAllowed(table lesson, Player ply, Entity computer)`  
    Returns if the specified slideshow can be opened  
    This function runs the `canOpenSlideshow_mr` event.
- *:blue_heart: SERVER:* `boolean prop_teacher_computer_mr.slideshowAllowedInWhitelist(table lesson, Player ply)`  
    Returns if the specified slideshow is allowed by the whitelist
